Date: 2018-04-08
Title: Containerized Golang Binaries with SSL capability
cat: ops,dev

Recently, I've had to containerize a Golang binary I use to report Kubernetes Node events generated by
[Node Problem Detector](https://github.com/kubernetes/node-problem-detector)

```
FROM scratch
ADD node-issue-reporter /
ADD node-issue-reporter.hcl /etc/
ENTRYPOINT ["/node-issue-reporter"]
```

I called this deployment `node-issue-reporter`. It would do several things:

1. Query a private DNS server for a TXT record with the AWS ARN of an SNS topic
2. Make an In-Cluster connection to Kubernetes and watch for new Node Events
3. Create an AWS SNS client and publish to it when a NodeCondition defined in `node-issue-reporter.hcl` is True

On a from-scratch container, functionality #3 will fail because any SSL connection in Go will rely on the `x509` package and throw this error:

`x509: failed to load system roots and no roots provided`

This is because x509 will look for root certificates in the following places:

```
package x509

...

// Possible directories with certificate files; stop after successfully
// reading at least one file from a directory.
var certDirectories = []string{
	"/etc/ssl/certs",               // SLES10/SLES11, https://golang.org/issue/12139
	"/system/etc/security/cacerts", // Android
	"/usr/local/share/certs",       // FreeBSD
	"/etc/pki/tls/certs",           // Fedora/RHEL
	"/etc/openssl/certs",           // NetBSD
}
...
```

In my case, I ended up building a lightweight container with Certificate Authorities using `alpine`:

```
FROM alpine:3.7
RUN apk update
RUN apk add ca-certificates
ADD node-issue-reporter /
ADD node-issue-reporter.hcl /etc/
ENTRYPOINT ["/node-issue-reporter"]
```

Now `node-issue-reporter` is able to make HTTPS requests.
